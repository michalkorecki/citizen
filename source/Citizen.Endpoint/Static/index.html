<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.2.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
    <script>
        $(document).ready(function () {
            $("div.container").on("click", "button.chart-loader", function (event) {
                $("tr#chart-container").remove();
                $(this)
                    .parent()
                    .parent()
                    .after(function () {
                        return "<tr id='chart-container'>" +
                                 "<td colspan='8'>" +
                                   "<div class='container'>" +
                                     "<div class='row'>" +
                                       "<div class='col-xs-6'>" +
                                         "<canvas id='run-time-chart' />" +
                                       "</div>" +
                                       "<div class='col-xs-6'>" +
                                         "<canvas id='lag-time-chart' />" +
                                       "</div>" +
                                     "</div>" +
                                   "</div>" + 
                                 "</td>" +
                               "</tr>";
                    });
                var buildDataUrl = $(this).attr("href");
                $.ajax({
                    url: buildDataUrl
                }).then(function (data) {
                    var build = data.build;
                    
                    var runTimes = data.run.map(function (b) { return b.durationInSeconds; });
                    var lastBuildRun = new Array(runTimes.length);
                    for (var i = 0; i < lastBuildRun.length; i++) {
                        lastBuildRun[i] = NaN;
                    }
                    lastBuildRun.push(build.runTimeInSeconds);
                    runTimes.push(NaN);

                    var lagTimes = data.lag.map(function (b) { return b.durationInSeconds; });
                    var lastBuildLag = new Array(lagTimes.length);
                    for (var i = 0; i < lastBuildLag.length; i++) {
                        lastBuildLag[i] = NaN;
                    }
                    lastBuildLag.push(build.lagTimeInSeconds);
                    lagTimes.push(NaN);

                    var labels = data.run.map(function (b) { return moment(b.date, "YYYYMMDDThh:mm:ss").format("DD MMM hh:mm"); });
                    labels.push("Last build");

                    var config1 = {
                        type: "line",
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: "Average building time",
                                    data: runTimes,
                                    borderColor: "#29a329",
                                    backgroundColor: "#29a329",
                                    pointRadius: 1,
                                    pointRadiusHover: 2,
                                    fill: false
                                },
                                {
                                    label: "Last build",
                                    data: lastBuildRun,
                                    borderColor: "#196619",
                                    backgroundColor: "#196619",
                                    pointRadius: 3,
                                    fill: false
                                },
                            ]
                        },
                        options: {
                            scales: {
                                yAxes: [
                                    {
                                        position: "left",
                                        ticks: {
                                            beginAtZero: false
                                        },
                                        scaleLabel: {
                                            display: true,
                                            labelString: "Building (seconds)"
                                        }
                                    }
                                ]
                            }
                        }
                    };
                    var config2 = {
                        type: "line",
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: "Average waiting time",
                                    data: lagTimes,
                                    borderColor: "#ff9933",
                                    backgroundColor: "#ff9933",
                                    pointRadius: 1,
                                    pointRadiusHover: 2,
                                    fill: false
                                },
                                {
                                    label: "Last build",
                                    data: lastBuildLag,
                                    borderColor: "#e67300",
                                    backgroundColor: "#e67300",
                                    pointRadius: 3,
                                    fill: false
                                },
                            ]
                        },
                        options: {
                            scales: {
                                yAxes: [
                                    {
                                        position: "left",
                                        ticks: {
                                            beginAtZero: false
                                        },
                                        scaleLabel: {
                                            display: true,
                                            labelString: "Waiting (seconds)"
                                        }
                                    }
                                ]
                            }
                        }
                    };
                    var context1 = document.getElementById("run-time-chart").getContext("2d");
                    window.runTimeChart = new Chart(context1, config1);
                    var context2 = document.getElementById("lag-time-chart").getContext("2d");
                    window.lagTimeChart = new Chart(context2, config2);
                });
            }); 

            var loadBuildsData = function () {
                $("div.container").empty();
                $.ajax({
                    url: document.URL + "builds"
                }).then(function (data) {
                    var createShowChartLink = function (buildTypeId) {
                        return "<button type='button' class='chart-loader btn btn-primary btn-xs' href='" + document.URL + "builds/" + buildTypeId + "'>Chart</button>";
                    };
                    var createBuildRow = function (item) {
                        return $(
                            "<tr>" +
                            "<td>" + item.buildTypeName + "</td>" +
                            "<td>" + item.buildCount + "</td>" +
                            "<td>" + item.averageLagTime + "</td>" +
                            "<td>" + item.averageRunTime + "</td>" +
                            "<td>" + "<a href=\"" + item.lastBuildUrl + "\">" + moment(item.lastBuildQueuedAt, "YYYYMMDDThh:mm:ss").fromNow() + "</a></td>" +
                            "<td>" + item.lastBuildLagTime + "</td>" +
                            "<td>" + item.lastBuildRunTime + "</td>" +
                            "<td>" + createShowChartLink(item.buildTypeId) + "</td>" +
                            "</tr>");
                    };

                    var table = $("<table class='table table-bordered table-condensed' />");
                    var head = $("<thead />");
                    var headRow = $("<tr />");
                    headRow.append("<th>Build type</th>");
                    headRow.append("<th>#</th>");
                    headRow.append("<th>Lag (avg)</th>");
                    headRow.append("<th>Run (avg)</th>");
                    headRow.append("<th>Last build</th>");
                    headRow.append("<th>Lag (last build)</th>");
                    headRow.append("<th>Run (last build)</th>");
                    headRow.append("<th>Chart</th>");
                    head.append(headRow);
                    table.append(head);
                    var body = $("<tbody />");
                    for (var item of data) {
                        var row = createBuildRow(item);
                        body.append(row);
                    }

                    table.append(body);
                    $("div.container").append(table);
                });
            };

            loadBuildsData();
        });
    </script>
</head>
<body>
    <h3>Builds</h3>
    <div class="container">
    </div>
</body>
</html>