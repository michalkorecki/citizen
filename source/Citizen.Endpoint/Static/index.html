<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.2.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
    <script>
        $(document).ready(function () {
            $("div.container").on("click", "button.chart-loader", function (event) {
                var buildDataUrl = $(this).attr("href");
                $("canvas#chart").parent().parent().remove();
                $(this).parent().parent().after(function () {
                    return "<tr><td colspan='8'><canvas id='chart' /></td></tr>";
                });
                $.ajax({
                    url: buildDataUrl
                }).then(function (data) {
                    var build = data.build;
                    
                    var runTimes = data.run.map(function (b) { return b.durationInSeconds; });
                    var lastBuild = new Array(runTimes.length);
                    for (var i = 0; i < lastBuild.length; i++) {
                        lastBuild[i] = NaN;
                    }
                    lastBuild.push(build.runTimeInSeconds);
                    runTimes.push(NaN);
                    var lagTimes = data.lag.map(function (b) { return b.durationInSeconds; });
                    lagTimes.push(NaN);
                    var labels = data.run.map(function (b) { return moment(b.date, "YYYYMMDDThh:mm:ss").format("DD MMM hh:mm"); });
                    labels.push("Last build");
                    var config = {
                        type: "line",
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: "Building",
                                    data: runTimes,
                                    yAxisID: "y-axis-run",
                                    borderColor: "#9fdf9f",
                                    backgroundColor: "#40bf40",
                                    fill: false
                                },
                                {
                                    label: "Last build",
                                    data: lastBuild,
                                    yAxisID: "y-axis-run",
                                    borderColor: "#9fdf9f",
                                    backgroundColor: "#40bf40",
                                    fill: false
                                },
                                {
                                    label: "Waiting",
                                    data: lagTimes,
                                    yAxisID: "y-axis-lag",
                                    borderColor: "#ff8080",
                                    backgroundColor: "#ff3333",
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            scales: {
                                yAxes: [
                                    {
                                        id: "y-axis-run",
                                        position: "left",
                                        ticks: {
                                            beginAtZero: false
                                        },
                                        scaleLabel: {
                                            display: true,
                                            labelString: "Building (seconds)"
                                        }
                                    },
                                    {
                                        id: "y-axis-lag",
                                        position: "right",
                                        ticks: {
                                            beginAtZero: false
                                        },
                                        gridLines: {
                                            drawOnChartArea: false
                                        },
                                        scaleLabel: {
                                            display: true,
                                            labelString: "Waiting (seconds)"
                                        }
                                    }
                                ]
                            }
                        }
                    };
                    var context = document.getElementById("chart").getContext("2d");
                    window.chart = new Chart(context, config);
                });
            }); 

            var loadBuildsData = function () {
                $("div.container").empty();
                $.ajax({
                    url: document.URL + "builds"
                }).then(function (data) {
                    var createShowChartLink = function (buildTypeId) {
                        return "<button type='button' class='chart-loader btn btn-primary btn-xs' href='" + document.URL + "builds/" + buildTypeId + "'>Chart</button>";
                    };
                    var createBuildRow = function (item) {
                        return $(
                            "<tr>" +
                            "<td>" + item.buildTypeName + "</td>" +
                            "<td>" + item.buildCount + "</td>" +
                            "<td>" + item.averageLagTime + "</td>" +
                            "<td>" + item.averageRunTime + "</td>" +
                            "<td>" + "<a href=\"" + item.lastBuildUrl + "\">" + moment(item.lastBuildQueuedAt, "YYYYMMDDThh:mm:ss").fromNow() + "</a></td>" +
                            "<td>" + item.lastBuildLagTime + "</td>" +
                            "<td>" + item.lastBuildRunTime + "</td>" +
                            "<td>" + createShowChartLink(item.buildTypeId) + "</td>" +
                            "</tr>");
                    };

                    var table = $("<table class='table table-bordered table-condensed' />");
                    var head = $("<thead />");
                    var headRow = $("<tr />");
                    headRow.append("<th>Build type</th>");
                    headRow.append("<th>#</th>");
                    headRow.append("<th>Lag (avg)</th>");
                    headRow.append("<th>Run (avg)</th>");
                    headRow.append("<th>Last build</th>");
                    headRow.append("<th>Lag (last build)</th>");
                    headRow.append("<th>Run (last build)</th>");
                    headRow.append("<th>Chart</th>");
                    head.append(headRow);
                    table.append(head);
                    var body = $("<tbody />");
                    for (var item of data) {
                        var row = createBuildRow(item);
                        body.append(row);
                    }

                    table.append(body);
                    $("div.container").append(table);
                });
            };

            loadBuildsData();
        });
    </script>
</head>
<body>
    <h3>Builds</h3>
    <div class="container">
    </div>
</body>
</html>